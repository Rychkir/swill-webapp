<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoWin Casino</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
            min-height: 100vh;
            color: white;
            line-height: 1.6;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
        }

        .logo {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .title {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
            color: #FFD700;
        }

        .subtitle {
            opacity: 0.8;
            font-size: 1em;
            margin-bottom: 20px;
        }

        .screen {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #1a1f2e;
            border: none;
            padding: 16px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 12px 0;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.2);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #FFD700;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 16px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.08);
            font-size: 16px;
            color: white;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #FFD700;
            background: rgba(255, 255, 255, 0.12);
        }

        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .terms-content {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
            line-height: 1.8;
        }

        .terms-content h3 {
            color: #FFD700;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .terms-content ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }

        .terms-content li {
            margin-bottom: 8px;
        }

        .debug-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 300px;
            height: 150px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            color: #00ff00;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .debug-toggle {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: #333;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 10px;
            cursor: pointer;
            z-index: 1001;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: 600;
            border: 2px solid transparent;
        }

        .message.success {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .message.error {
            background: rgba(244, 67, 54, 0.2);
            border-color: #F44336;
            color: #F44336;
        }

        .message.info {
            background: rgba(33, 150, 243, 0.2);
            border-color: #2196F3;
            color: #2196F3;
        }

        .code-input {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 10px;
        }

        .resend-link {
            text-align: center;
            margin-top: 20px;
        }

        .resend-link a {
            color: #FFD700;
            text-decoration: none;
            cursor: pointer;
        }

        .resend-link a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loadingScreen" class="screen active">
            <div class="header">
                <div class="logo">üé∞</div>
                <div class="title">CryptoWin Casino</div>
                <div class="subtitle">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —É—Å–ª–æ–≤–∏–π -->
        <div id="termsScreen" class="screen">
            <div class="header">
                <div class="logo">üìã</div>
                <div class="title">–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</div>
            </div>
            
            <div class="terms-content">
                <h3>–ü—Ä–∞–≤–∏–ª–∞ –∏ —É—Å–ª–æ–≤–∏—è CryptoWin Casino</h3>
                
                <p><strong>1. –û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è</strong></p>
                <ul>
                    <li>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞: 18 –ª–µ—Ç</li>
                    <li>–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—è—Å—å, –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —Å–≤–æ–µ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–∏–µ</li>
                    <li>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞ —Å–æ–±–æ–π –ø—Ä–∞–≤–æ –∏–∑–º–µ–Ω—è—Ç—å –ø—Ä–∞–≤–∏–ª–∞</li>
                </ul>

                <p><strong>2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –∞–∫–∫–∞—É–Ω—Ç</strong></p>
                <ul>
                    <li>–û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –æ–¥–∏–Ω –∞–∫–∫–∞—É–Ω—Ç</li>
                    <li>–ó–∞–ø—Ä–µ—â–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</li>
                    <li>–í—ã –Ω–µ—Å–µ—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Å–≤–æ–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞</li>
                </ul>

                <p><strong>3. –ò–≥—Ä–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å</strong></p>
                <ul>
                    <li>–í—Å–µ –∏–≥—Ä—ã –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–µ —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª</li>
                    <li>–ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–æ—Ç–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤</li>
                    <li>–†–µ—à–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å–ø–æ—Ä–Ω—ã–º —Å–∏—Ç—É–∞—Ü–∏—è–º –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã</li>
                </ul>

                <p><strong>4. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–∞—è –∏–≥—Ä–∞</strong></p>
                <ul>
                    <li>–ò–≥—Ä–∞–π—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ –∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Å–≤–æ–∏—Ö —Å—Ä–µ–¥—Å—Ç–≤</li>
                    <li>–ü–æ–º–Ω–∏—Ç–µ, —á—Ç–æ –∞–∑–∞—Ä—Ç–Ω—ã–µ –∏–≥—Ä—ã –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å</li>
                    <li>–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</li>
                </ul>

                <p><strong>5. –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</strong></p>
                <ul>
                    <li>–ú—ã –∑–∞—â–∏—â–∞–µ–º –≤–∞—à–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</li>
                    <li>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º</li>
                    <li>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</li>
                </ul>
            </div>

            <button class="btn" onclick="acceptTerms()">
                ‚úÖ –Ø –ü–†–û–ß–ò–¢–ê–õ –ò –ü–†–ò–ù–ò–ú–ê–Æ –£–°–õ–û–í–ò–Ø
            </button>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
        <div id="registerScreen" class="screen">
            <div class="header">
                <div class="logo">üìß</div>
                <div class="title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
                <div class="subtitle">–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</div>
            </div>

            <div class="input-group">
                <label for="email">EMAIL –ê–î–†–ï–°</label>
                <input type="email" id="email" placeholder="your.email@example.com" required>
            </div>

            <div class="input-group">
                <label for="referralCode">–†–ï–§–ï–†–ê–õ–¨–ù–´–ô –ö–û–î (–ù–ï–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)</label>
                <input type="text" id="referralCode" placeholder="ABCD1234">
            </div>

            <button class="btn" onclick="registerEmail()">
                üìß –ü–û–õ–£–ß–ò–¢–¨ –ö–û–î –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
            </button>

            <div id="registerMessage" class="message"></div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫–æ–¥–∞ -->
        <div id="verifyScreen" class="screen">
            <div class="header">
                <div class="logo">üîê</div>
                <div class="title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ Email</div>
                <div class="subtitle">–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ Telegram</div>
            </div>

            <div class="input-group">
                <label for="verificationCode">–ö–û–î –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø</label>
                <input type="text" id="verificationCode" 
                       placeholder="123456" 
                       maxlength="6" 
                       class="code-input"
                       oninput="formatCode(this)">
            </div>

            <button class="btn" onclick="verifyCode()">
                ‚úÖ –ü–û–î–¢–í–ï–†–î–ò–¢–¨
            </button>

            <div class="resend-link">
                <a onclick="resendCode()">üîÑ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ</a>
            </div>

            <div id="verifyMessage" class="message"></div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω –∫–∞–∑–∏–Ω–æ -->
        <div id="mainScreen" class="screen">
            <div class="header">
                <div class="logo">üé∞</div>
                <div class="title">CryptoWin Casino</div>
                <div class="subtitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</div>
            </div>

            <div class="message info">
                –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!
            </div>

            <button class="btn" onclick="getBalance()">
                üí∞ –ü–†–û–í–ï–†–ò–¢–¨ –ë–ê–õ–ê–ù–°
            </button>
        </div>
    </div>

    <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <button class="debug-toggle" onclick="toggleDebug()">DEBUG</button>
    <div class="debug-panel" id="debugPanel">
        Debug console initialized...
    </div>

    <script>
        let tg = null;
        let userData = {
            balance: 0,
            stars: 0,
            isRegistered: false,
            email: ''
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        function initTelegramApp() {
            try {
                tg = window.Telegram.WebApp;
                tg.expand();
                tg.enableClosingConfirmation();
                
                logDebug('‚úÖ Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                logDebug('üì± –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ' + tg.platform);
                logDebug('üî¢ –í–µ—Ä—Å–∏—è WebApp: ' + tg.version);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ª–æ–≤–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
                setTimeout(() => {
                    hideScreen('loadingScreen');
                    showScreen('termsScreen');
                }, 1000);
                
            } catch (error) {
                logDebug('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram: ' + error);
                // Fallback –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ Telegram
                setTimeout(() => {
                    hideScreen('loadingScreen');
                    showScreen('termsScreen');
                }, 1000);
            }
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —ç–∫—Ä–∞–Ω–∞–º
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            logDebug('üîÑ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —ç–∫—Ä–∞–Ω: ' + screenId);
        }

        function hideScreen(screenId) {
            document.getElementById(screenId).classList.remove('active');
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        function formatCode(input) {
            input.value = input.value.replace(/[^0-9]/g, '').slice(0, 6);
        }

        // –ü—Ä–∏–Ω—è—Ç–∏–µ —É—Å–ª–æ–≤–∏–π
        function acceptTerms() {
            logDebug('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–Ω—è–ª —É—Å–ª–æ–≤–∏—è');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ –±–æ—Ç–∞
            sendToBot({
                action: 'accept_terms'
            });
            
            showScreen('registerScreen');
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è email
        function registerEmail() {
            const email = document.getElementById('email').value.trim();
            const referralCode = document.getElementById('referralCode').value.trim().toUpperCase();
            const messageElement = document.getElementById('registerMessage');
            
            if (!email) {
                showMessage(messageElement, '–í–≤–µ–¥–∏—Ç–µ email –∞–¥—Ä–µ—Å', 'error');
                return;
            }

            if (!validateEmail(email)) {
                showMessage(messageElement, '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å', 'error');
                return;
            }

            userData.email = email;
            
            const data = {
                action: 'register_email',
                email: email
            };

            if (referralCode) {
                data.referral_code = referralCode;
                logDebug('üë• –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: ' + referralCode);
            }

            showMessage(messageElement, '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...', 'info');
            logDebug('üìß –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è email: ' + email);
            
            sendToBot(data);
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è email
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–¥–∞
        function verifyCode() {
            const code = document.getElementById('verificationCode').value.trim();
            const messageElement = document.getElementById('verifyMessage');
            
            if (!code || code.length !== 6) {
                showMessage(messageElement, '–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è', 'error');
                return;
            }

            logDebug('üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞: ' + code);
            showMessage(messageElement, '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...', 'info');
            
            sendToBot({
                action: 'verify_2fa',
                code: code
            });
        }

        // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞
        function resendCode() {
            const messageElement = document.getElementById('verifyMessage');
            
            if (!userData.email) {
                showMessage(messageElement, '–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ email', 'error');
                showScreen('registerScreen');
                return;
            }

            logDebug('üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –Ω–∞: ' + userData.email);
            showMessage(messageElement, '–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞...', 'info');
            
            sendToBot({
                action: 'register_email',
                email: userData.email
            });
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
        function getBalance() {
            logDebug('üí∞ –ó–∞–ø—Ä–æ—Å –±–∞–ª–∞–Ω—Å–∞');
            sendToBot({
                action: 'get_balance'
            });
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–∞
        function sendToBot(data) {
            logDebug('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç–∞: ' + JSON.stringify(data));
            
            if (tg && tg.sendData) {
                try {
                    // –û–ß–ï–ù–¨ –í–ê–ñ–ù–û: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Å—Ç—Ä–æ–∫—É JSON
                    tg.sendData(JSON.stringify(data));
                    logDebug('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ Telegram WebApp');
                } catch (error) {
                    logDebug('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ WebApp: ' + error);
                    showMessage(document.getElementById('registerMessage'), '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
                }
            } else {
                logDebug('‚ö†Ô∏è Telegram WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                showMessage(document.getElementById('registerMessage'), 'WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç –±–æ—Ç–∞
        function handleBotResponse(data) {
            logDebug('üì• –û—Ç–≤–µ—Ç –æ—Ç –±–æ—Ç–∞: ' + JSON.stringify(data));
            
            const verifyMessage = document.getElementById('verifyMessage');
            const registerMessage = document.getElementById('registerMessage');
            
            if (data.success) {
                switch(data.step) {
                    case 'code_sent':
                        showMessage(registerMessage, 
                                   `‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram!`, 
                                   'success');
                        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —ç–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                        setTimeout(() => {
                            showScreen('verifyScreen');
                            showMessage(verifyMessage, 
                                       '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞.', 
                                       'info');
                        }, 1000);
                        break;
                    case 'completed':
                        showMessage(verifyMessage, data.message, 'success');
                        userData.isRegistered = true;
                        userData.balance = data.balance || 0;
                        userData.stars = data.stars || 0;
                        
                        setTimeout(() => {
                            showScreen('mainScreen');
                        }, 2000);
                        break;
                    default:
                        if (data.message) {
                            showMessage(verifyMessage, data.message, 'success');
                        }
                }
                
                if (data.action === 'balance_info') {
                    userData.balance = data.balance || 0;
                    userData.stars = data.stars || 0;
                    logDebug(`üí∞ –ë–∞–ª–∞–Ω—Å: ${userData.balance} –º–æ–Ω–µ—Ç, ‚≠ê –ó–≤–µ–∑–¥: ${userData.stars}`);
                    showMessage(document.getElementById('registerMessage'), 
                               `–ë–∞–ª–∞–Ω—Å: ${userData.balance} –º–æ–Ω–µ—Ç, –ó–≤–µ–∑–¥: ${userData.stars}`, 'success');
                }

                if (data.action === 'terms_accepted') {
                    logDebug('‚úÖ –£—Å–ª–æ–≤–∏—è –ø—Ä–∏–Ω—è—Ç—ã –±–æ—Ç–æ–º');
                }
            } else {
                showMessage(verifyMessage, data.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
                showMessage(registerMessage, data.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(element, message, type) {
            if (!element) return;
            
            element.textContent = message;
            element.className = 'message';
            
            switch(type) {
                case 'success':
                    element.classList.add('success');
                    break;
                case 'error':
                    element.classList.add('error');
                    break;
                case 'info':
                    element.classList.add('info');
                    break;
            }
            
            logDebug(`üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ [${type}]: ${message}`);
        }

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        function logDebug(message) {
            const debugPanel = document.getElementById('debugPanel');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            if (debugPanel) {
                debugPanel.innerHTML = logEntry + debugPanel.innerHTML;
            }
            
            console.log(message);
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –ø–∞–Ω–µ–ª–∏
        function toggleDebug() {
            const debugPanel = document.getElementById('debugPanel');
            if (debugPanel.style.display === 'block') {
                debugPanel.style.display = 'none';
            } else {
                debugPanel.style.display = 'block';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            logDebug('üöÄ WebApp –∑–∞–≥—Ä—É–∂–µ–Ω');
            initTelegramApp();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.onEvent('message', (event) => {
                    try {
                        logDebug('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞: ' + event);
                        const data = JSON.parse(event);
                        handleBotResponse(data);
                    } catch (e) {
                        logDebug('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –±–æ—Ç–∞: ' + e);
                    }
                });
            } else {
                logDebug('‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π Telegram –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
            }
        });

        // Fallback –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        window.handleBotResponse = handleBotResponse;
    </script>
</body>
</html>
